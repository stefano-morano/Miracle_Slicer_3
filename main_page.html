<!DOCTYPE html>
 <!-- main page of the slicer -->
    <head>
        <title>Miracle Slicer 3</title>
        <h1>Miracle Slicer 3</h1>
        <style>
            #slicer{
                width: 450px;
                height: 600px;
                border: 5px solid black;
                background-color: lightblue;
                border-radius: 10px;
                margin: auto;
                justify-content: center;
                align-items: center;
            }

            .button {
                background-color: grey; /* Green */
                border: none;
                color: black;
                padding: 15px 32px;
                text-align: center;
                position: relative;
                text-decoration: none;
                border-radius: 10px;
                border: 2px solid black;
                margin: 2px;
                display: inline-block;
                font-size: 16px;
                cursor: pointer;
                transition: 0.5;
            }
            
            .button:hover{
                background-color: lightgrey;
            }

            #waveform{
                width: 440px;
                height: 200px;
                border: 5px solid black;
                background-color: white;
                border-radius: 10px;
                margin: auto;
                align-items: center;
            }

        </style>
    </head>

    <body>
        <div id="slicer">
            <input class="button" type="file" accept="audio/*" id="fileInput">
            <button class="button" onclick="loadFile()">Load file</button>
            <button class="button" onclick="playAudioBuffer()">Play</button>
            <button class="button" onclick="clear()">Clear</button>
            <div id="waveform" style="position: relative;">
                <canvas id="waveformCanvas" width="440" height="200" style="position: absolute; z-index: 1;"></canvas>
            </div>
            <label for="midiSelect">Seleziona un dispositivo MIDI:</label>
            <select id="midiSelect"></select>
        </div>

        <script>
            var context = new (window.AudioContext || window.webkitAudioContext)();
            var audioBuffer;
            var animationId;
            var startTime;
            var index = [0];
            var selectedRange = [];

            async function getMidi(){                                       //scan every midi inputs and add them to the select menu
                var midi = await navigator.requestMIDIAccess();
                const inputs = midi.inputs.values();
                const midiSelect = document.getElementById('midiSelect');
                for (const input of inputs) {
                    const option = document.createElement('option');
                    option.value = input.id;
                    option.text = input.name;
                    midiSelect.add(option);
                }

                var selectedInput = midi.inputs.get(midiSelect.value);      //the first input is selected by default

                midiSelect.addEventListener('change', (event) => {          //when a midi input is selected, the selectedInput variable is updated
                    const selectedDeviceId = event.target.value;
                    console.log(`Dispositivo MIDI selezionato: ${selectedDeviceId}`);
                    selectedInput = midiAccess.inputs.get(selectedDeviceId);
                });

                selectedInput.onmidimessage = function (event) {            //when a midi input message is received, the function is called
                        if (event.data[0] == 144) {
                            var note = map_note(event.data[1]);
                            if (note < index.length - 1) {
                                play(note);
                            }
                        } else {
                            stop();
                        }
                };
            }

            getMidi();                                                      //call the function to scan midi inputs as first thing
            
            function loadFile() {                                           //load the audio file and save it in the buffer
                console.log("chiamata loadFile");
                var fileInput = document.getElementById('fileInput');

                if (!fileInput.files || fileInput.files.length === 0) {
                    alert('Seleziona un file audio prima di procedere.');
                    return;
                }

                var audioFile = fileInput.files[0];
                var reader = new FileReader();

                reader.onload = function (event) {
                    var audioData = event.target.result;
                    context.decodeAudioData(audioData,
                        function(buffer){
                            audioBuffer = buffer;
                            addIndexInOrder(audioBuffer.duration);
                            selectedRange[0] = 0;
                            selectedRange[1] = audioBuffer.duration;
                            alert('File audio caricato e salvato nel buffer: ', buffer);
                            drawWaveform(); 
                        },
                        function(error){
                            alert('Errore durante la decodifica del file audio: ', error);
                        }
                    );
                };
                reader.readAsArrayBuffer(audioFile);
            }

            function playAudioBuffer() {                                        //play the audio buffer
                var source = context.createBufferSource();
                source.buffer = audioBuffer;
                source.connect(context.destination);
                source.onended = function() {
                    cancelAnimationFrame(animationId);
                };

                startTime = context.currentTime;
                animate();
                source.start(0, 0, audioBuffer.duration);
            }

            function play(note) {                                               //play the audio buffer from the selected note
                var source = context.createBufferSource();
                source.buffer = audioBuffer;
                source.connect(context.destination);
                source.start(0, index[note], index[note+1]-index[note]);
            }

            function animate() {
                // Calcola il tempo trascorso dalla riproduzione iniziale
                var currentTime = context.currentTime - startTime;

                // Chiamare la funzione per disegnare l'onda sonora
                drawWaveform(currentTime);

                // Richiamare se stessi per continuare l'animazione
                animationId = requestAnimationFrame(animate);
            }

            function mapKeyToNumber(key) {
                switch (key) {
                    case 'a':
                        return 0;
                    case 's':
                        return 1;
                    case 'd':
                        return 2;
                    case 'f':
                        return 3;
                    case 'g':
                        return 4;
                    case 'h':
                        return 5;
                    case 'j':
                        return 6;
                    case 'k':
                        return 7;
                    case 'l':
                        return 8;
                    default:
                        return undefined;
                }
            }

            document.addEventListener('keydown', function(event) {
                const keyPressed = event.key.toLowerCase(); 
                const mappedNumber = mapKeyToNumber(keyPressed);
                console.log(mappedNumber);
                if (mappedNumber !== undefined && mappedNumber < index.lenght - 1) {
                    play(mappedNumber);
                }
            });

            function map_note(note){
                var value = (note - 48) / 24;
                return Math.round(value * 14) + 0;
            }

            function drawWaveform(currentTime) {                                //draw the waveform of the audio buffer
                if (!audioBuffer) {
                    console.error('audioBuffer non Ã¨ definito.');
                    return;
                }

                var canvas = document.getElementById('waveformCanvas');
                var ctx = canvas.getContext('2d');
                var bufferData = audioBuffer.getChannelData(0);

                ctx.fillStyle = 'rgb(255, 255, 255)'; // Sfondo bianco
                ctx.fillRect(0, 0, canvas.width, canvas.height);

                ctx.lineWidth = 2;
                ctx.strokeStyle = 'rgb(0, 0, 0)'; // Onda nera
                ctx.beginPath();

                var sliceWidth = canvas.width * 1.0 / bufferData.length;
                var x = 0;

                for (var i = 0; i < bufferData.length; i++) {
                    var y = (bufferData[i] + 1) * canvas.height / 2;
                        if (i === 0) {
                            ctx.moveTo(x, y);
                        } else {
                            ctx.lineTo(x, y);
                        }
                    x += sliceWidth;
                }

                ctx.lineTo(canvas.width, canvas.height / 2);
                ctx.stroke();
            }


            document.getElementById('waveformCanvas').addEventListener('mousedown', function(event) {
                event.preventDefault();
                var canvas = document.getElementById('waveformCanvas');
                var ctx = canvas.getContext('2d');
                var rect = canvas.getBoundingClientRect();
                var mouseX = event.clientX - rect.left;
                var bufferIndex = (mouseX / canvas.width) * audioBuffer.duration;
                if (event.button === 0) {
                    var x = 0;
                    while (index[x] > bufferIndex || index[x+1] < bufferIndex){
                        x++;
                    }
                    selectedRange[0] = index[x];
                    selectedRange[1] = index[x+1];
                    ctx.fillStyle = 'rgba(255, 255, 0, 0.5)'; // Rettangolo giallo trasparente
                    ctx.fillRect((index[x]/audioBuffer.duration)*canvas.width, 0, (index[x+1]/audioBuffer.duration)*canvas.width - (index[x]/audioBuffer.duration)*canvas.width, canvas.height);
                } else if (event.button === 2) {
                    addIndexInOrder(bufferIndex);
                    console.log(index);
                    drawVerticalLine(mouseX);
                }
            });

function addIndexInOrder(num) {
    if (!index.includes(num)) {
        index.push(num);
        index.sort(function(a, b) {
            return a - b;
        });
    }
}

function secondsToBufferIndex(time) {
    return Math.floor(time * audioBuffer.sampleRate);
}

function invertBufferWaveform(startIndex, endIndex) {
    if (!audioBuffer || startIndex < 0 || endIndex >= audioBuffer.length || startIndex >= endIndex) {
        return;
    }
    var bufferData = audioBuffer.getChannelData(0).subarray(startIndex, endIndex + 1).slice();
    bufferData.reverse();
    audioBuffer.getChannelData(0).set(bufferData, startIndex);
    drawWaveform();
    restoreLines();
}

function drawVerticalLine(x) {
    var canvas = document.getElementById('waveformCanvas');
    var ctx = canvas.getContext('2d');
    ctx.beginPath();
    ctx.strokeStyle = 'rgb(255, 0, 0)'; // Linea rossa
    ctx.moveTo(x, 0);
    ctx.lineTo(x, canvas.height);
    ctx.stroke();
}

function restoreLines(){
    var position;
    var canvas = document.getElementById('waveformCanvas');
    var ctx = canvas.getContext('2d');
    
    for (var x=1; x<=index.lenght; x++){
        ctx.beginPath();
        ctx.strokeStyle = 'rgb(255, 0, 0)'; 
        position = (index[x]/audioBuffer.duration)*canvas.width;
        console.log(position);
        ctx.moveTo(position, 0);
        ctx.lineTo(position, canvas.height);
    }
    ctx.stroke();
}

        </script>
    </body>

</html>